<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Korean Grammar Practice</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          animation: {
            'gradient': 'gradient 15s ease infinite',
            'gradient-text': 'gradient-text 3s ease infinite',
            'blob': 'blob 7s infinite',
            'float': 'float 6s ease-in-out infinite',
            'bounce-subtle': 'bounce-subtle 2s ease-in-out infinite',
            'twinkle': 'twinkle 1.5s ease-in-out infinite',
          }
        }
      }
    }
  </script>
  <style>
    @keyframes gradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    @keyframes gradient-text {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    @keyframes blob {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(20px, -50px) scale(1.1); }
      50% { transform: translate(-20px, 20px) scale(0.9); }
      75% { transform: translate(50px, 50px) scale(1.05); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-20px) rotate(5deg); }
      50% { transform: translateY(-40px) rotate(-5deg); }
      75% { transform: translateY(-20px) rotate(3deg); }
    }
    
    @keyframes bounce-subtle {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.95); }
    }
    
    .gradient-bg {
      background: linear-gradient(-45deg, #a855f7, #e879f9, #06b6d4, #a855f7);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Lucide icons as components
    const CheckCircle = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
    );
    
    const XCircle = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
    );
    
    const ArrowRight = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="5" y1="12" x2="19" y2="12"></line>
        <polyline points="12 5 19 12 12 19"></polyline>
      </svg>
    );
    
    const ArrowLeft = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="19" y1="12" x2="5" y2="12"></line>
        <polyline points="12 19 5 12 12 5"></polyline>
      </svg>
    );
    
    const Sparkles = () => (
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
        <path d="M5 3v4"></path>
        <path d="M19 17v4"></path>
        <path d="M3 5h4"></path>
        <path d="M17 19h4"></path>
      </svg>
    );
    
    const Star = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
      </svg>
    );

    const Brain = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"></path>
        <path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"></path>
        <path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"></path>
        <path d="M17.599 6.5a3 3 0 0 0 .399-1.375"></path>
        <path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"></path>
        <path d="M3.477 10.896a4 4 0 0 1 .585-.396"></path>
        <path d="M19.938 10.5a4 4 0 0 1 .585.396"></path>
        <path d="M6 18a4 4 0 0 1-1.967-.516"></path>
        <path d="M19.967 17.484A4 4 0 0 1 18 18"></path>
      </svg>
    );

    const Zap = () => (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
      </svg>
    );

    const KoreanGrammarApp = () => {
      const [grammarPatterns, setGrammarPatterns] = useState(null);
      const [screen, setScreen] = useState('tier-selection');
      const [selectedTier, setSelectedTier] = useState(null);
      const [selectedPattern, setSelectedPattern] = useState(null);
      const [difficulty, setDifficulty] = useState(null);
      const [inputMode, setInputMode] = useState(null);
      const [currentSentenceSet, setCurrentSentenceSet] = useState(null);
      const [challengeMode, setChallengeMode] = useState(null);
      const [timeLimit, setTimeLimit] = useState(null);
      const [score, setScore] = useState(0);
      const [streak, setStreak] = useState(0);
      const [currentTense, setCurrentTense] = useState('past');
      const [shuffledParts, setShuffledParts] = useState([]);
      const [selectedParts, setSelectedParts] = useState([]);
      const [typedAnswer, setTypedAnswer] = useState('');
      const [showFeedback, setShowFeedback] = useState(false);
      const [isCorrect, setIsCorrect] = useState(false);
      const [questionsAnswered, setQuestionsAnswered] = useState(0);
      const [tensesCompleted, setTensesCompleted] = useState([]);
      
      // Heat Map and Boss Battle states
      const [heatMapData, setHeatMapData] = useState(() => {
        const saved = localStorage.getItem('korean-grammar-heatmap');
        return saved ? JSON.parse(saved) : {};
      });
      const [bossBattleMode, setBossBattleMode] = useState(false);
      const [bossHealth, setBossHealth] = useState(100);
      const [currentBoss, setCurrentBoss] = useState(null);
      const [bossBattlesCompleted, setBossBattlesCompleted] = useState(0);

      const distractorWords = {
        beginner: ['어제', '내일', '오늘', '지금', '학교에', '집에', '친구랑', '혼자', '공부하러', '가요', '저는', '이것은'],
        intermediate: ['어제', '내일', '오늘', '지금', '매일', '학교에', '집에', '회사에', '친구랑', '혼자', '공부하러', '일하러', '가요', '간다', '그래서', '하지만'],
        advanced: ['어제', '내일', '오늘', '지금', '학교에', '집에', '회사에', '강남에', '친구랑', '부모님이랑', '혼자서', '공부하러', '일하러', '가요', '간다', '가셨어요', '그래서', '하지만', '왜냐하면']
      };

      useEffect(() => {
        console.log('Fetching sentences.json...');
        fetch('sentences.json?v=' + Date.now())
          .then(response => {
            console.log('Response status:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Data loaded successfully:', data);
            setGrammarPatterns(data);
          })
          .catch(error => {
            console.error('Error loading sentences:', error);
          });
      }, []);

      // Save heat map data to localStorage whenever it changes
      useEffect(() => {
        localStorage.setItem('korean-grammar-heatmap', JSON.stringify(heatMapData));
      }, [heatMapData]);

      // Heat Map Functions
      const updateHeatMap = (patternId, tier, correct) => {
        const key = `${tier}-${patternId}`;
        setHeatMapData(prev => {
          const newData = { ...prev };
          if (!newData[key]) {
            newData[key] = { practiced: 0, correct: 0, incorrect: 0 };
          }
          newData[key].practiced++;
          if (correct) {
            newData[key].correct++;
          } else {
            newData[key].incorrect++;
          }
          return newData;
        });
      };

      const resetHeatMap = () => {
        setHeatMapData({});
        localStorage.removeItem('korean-grammar-heatmap');
      };

      const getHeatMapStats = () => {
        const stats = {};
        Object.keys(heatMapData).forEach(key => {
          const data = heatMapData[key];
          const accuracy = data.practiced > 0 ? (data.correct / data.practiced * 100).toFixed(1) : 0;
          stats[key] = {
            practiced: data.practiced,
            accuracy: parseFloat(accuracy),
            needsWork: data.incorrect > data.correct
          };
        });
        return stats;
      };

      // Random Mode Functions
      const startRandomMode = () => {
        console.log('Starting Random Mode...');
        console.log('grammarPatterns:', grammarPatterns);
        
        if (!grammarPatterns) {
          console.log('No grammar patterns available');
          return;
        }
        
        // Collect all patterns from all tiers
        const allPatterns = [];
        Object.keys(grammarPatterns).forEach(tier => {
          if (grammarPatterns[tier] && Array.isArray(grammarPatterns[tier])) {
            grammarPatterns[tier].forEach(pattern => {
              allPatterns.push({
                ...pattern,
                tier: tier
              });
            });
          }
        });
        
        console.log('All patterns:', allPatterns.length);
        
        if (allPatterns.length === 0) {
          console.log('No patterns found');
          return;
        }
        
        // Pick a random pattern
        const randomPattern = allPatterns[Math.floor(Math.random() * allPatterns.length)];
        console.log('Random pattern selected:', randomPattern);
        
        // Get all sentences from this pattern
        const allSentences = [];
        Object.keys(randomPattern.sentences).forEach(difficulty => {
          if (randomPattern.sentences[difficulty]) {
            if (randomPattern.tenseVariations) {
              // For patterns with tense variations, add each tense
              randomPattern.sentences[difficulty].forEach(sentenceSet => {
                Object.keys(sentenceSet).forEach(tense => {
                  if (sentenceSet[tense] && sentenceSet[tense].parts) {
                    allSentences.push({
                      ...sentenceSet[tense],
                      difficulty: difficulty,
                      tense: tense,
                      patternId: randomPattern.id,
                      patternName: randomPattern.name,
                      tier: randomPattern.tier
                    });
                  }
                });
              });
            } else {
              // For patterns without tense variations
              randomPattern.sentences[difficulty].forEach(sentence => {
                if (sentence && sentence.parts) {
                  allSentences.push({
                    ...sentence,
                    difficulty: difficulty,
                    patternId: randomPattern.id,
                    patternName: randomPattern.name,
                    tier: randomPattern.tier
                  });
                }
              });
            }
          }
        });
        
        console.log('All sentences:', allSentences.length);
        
        if (allSentences.length === 0) {
          console.log('No valid sentences found');
          return;
        }
        
        // Pick a random sentence
        const randomSentence = allSentences[Math.floor(Math.random() * allSentences.length)];
        console.log('Random sentence selected:', randomSentence);
        
        // Set up the random mode
        setSelectedPattern(randomPattern);
        setDifficulty(randomSentence.difficulty);
        
        // Handle sentence structure properly for Random Mode
        if (randomSentence.tense && randomPattern.tenseVariations) {
          // For tense variations, we need to structure it properly
          const tenseSentenceSet = {};
          tenseSentenceSet[randomSentence.tense] = {
            parts: randomSentence.parts,
            meaning: randomSentence.meaning
          };
          setCurrentSentenceSet(tenseSentenceSet);
          setCurrentTense(randomSentence.tense);
        } else {
          // For direct sentences (no tense variations)
          setCurrentSentenceSet({
            parts: randomSentence.parts,
            meaning: randomSentence.meaning
          });
        }
        
        setScreen('practice');
        
        // Set random input mode (50/50 chance)
        const randomInputMode = Math.random() < 0.5 ? 'tap' : 'typing';
        setInputMode(randomInputMode);
        
        // Reset states
        setShuffledParts([]);
        setSelectedParts([]);
        setTypedAnswer('');
        setShowFeedback(false);
        setIsCorrect(false);
        
        console.log('About to setup question...');
        // Setup question properly - pass the structured sentence
        if (randomSentence.tense && randomPattern.tenseVariations) {
          setupQuestion({
            [randomSentence.tense]: {
              parts: randomSentence.parts,
              meaning: randomSentence.meaning
            }
          }, randomSentence.tense);
        } else {
          setupQuestion({
            parts: randomSentence.parts,
            meaning: randomSentence.meaning
          }, null);
        }
      };

      // Boss Battle Functions
      const startBossBattle = () => {
        if (!grammarPatterns?.combo) return;
        
        const comboPatterns = grammarPatterns.combo;
        const randomBoss = comboPatterns[Math.floor(Math.random() * comboPatterns.length)];
        
        setCurrentBoss({
          name: randomBoss.name,
          description: randomBoss.description,
          pattern: randomBoss,
          difficulty: 'advanced',
          attacksRemaining: 5, // Boss needs 5 correct answers to defeat
          specialAbility: 'Multi-Pattern Master' // Boss special ability
        });
        setBossHealth(100);
        setBossBattleMode(true);
        setScreen('boss-battle');
        
        // Generate a super-challenging combo sentence
        generateBossSentence(randomBoss);
      };

      const generateBossSentence = (bossPattern) => {
        // Create a sentence that combines multiple grammar patterns for maximum difficulty
        const comboSentences = bossPattern.sentences.boss;
        const randomSentence = comboSentences[Math.floor(Math.random() * comboSentences.length)];
        
        // Make boss sentences harder by adding more distractors
        setCurrentSentenceSet(randomSentence);
        setSelectedPattern(bossPattern);
        setDifficulty('advanced');
        
        // Boss battles always use typing mode for maximum challenge
        setInputMode('typing');
        
        // Setup question with more distractors for boss battles
        const correctParts = [...randomSentence.parts];
        const distractors = [
          ...distractorWords.advanced,
          '그러니까', '그런데', '하지만', '그래서', '왜냐하면',
          '아무리', '비록', '만약', '설령', '혹시',
          '정말', '정말로', '진짜', '완전히', '정말로'
        ];
        
        const numDistractors = 8; // More distractors for boss battles
        const selectedDistractors = [];
        const shuffledDistractors = shuffleArray([...distractors]);

        for (let i = 0; i < numDistractors && i < shuffledDistractors.length; i++) {
          if (!correctParts.includes(shuffledDistractors[i])) {
            selectedDistractors.push(shuffledDistractors[i]);
          }
        }

        const allParts = [...correctParts, ...selectedDistractors];
        setShuffledParts(shuffleArray(allParts));
        setSelectedParts([]);
        setTypedAnswer('');
        setShowFeedback(false);
        setIsCorrect(false);
      };

      const bossAttack = () => {
        setCurrentBoss(prev => {
          const newBoss = { ...prev, attacksRemaining: prev.attacksRemaining - 1 };
          if (newBoss.attacksRemaining <= 0) {
            // Boss defeated!
            setBossBattlesCompleted(prev => prev + 1);
            setTimeout(() => {
              setBossBattleMode(false);
              setScreen('tier-selection');
              setCurrentBoss(null);
              setBossHealth(100);
            }, 3000);
          } else {
            // Generate next boss sentence
            setTimeout(() => {
              generateBossSentence(newBoss.pattern);
            }, 1500);
          }
          return newBoss;
        });
      };

      const bossDefend = () => {
        // Boss gets stronger with each wrong answer
        setCurrentBoss(prev => ({ ...prev, attacksRemaining: prev.attacksRemaining + 1 }));
        setScore(prev => Math.max(0, prev - 2));
        
        // Generate new boss sentence after wrong answer
        setTimeout(() => {
          generateBossSentence(currentBoss.pattern);
        }, 1500);
      };

      const shuffleArray = (array) => {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
      };

      const setupQuestion = (sentence, tense) => {
        console.log('setupQuestion called with:', sentence, tense);
        
        const correctParts = tense ? [...sentence[tense].parts] : [...sentence.parts];
        console.log('Correct parts:', correctParts);
        
        // Get difficulty from the sentence if available, otherwise use current difficulty
        const currentDifficulty = sentence.difficulty || difficulty || 'beginner';
        console.log('Current difficulty:', currentDifficulty);
        
        const distractors = distractorWords[currentDifficulty];
        console.log('Distractors:', distractors);
        
        const numDistractors = Math.floor(Math.random() * 4) + 5;
        const selectedDistractors = [];
        const shuffledDistractors = shuffleArray([...distractors]);

        for (let i = 0; i < numDistractors && i < shuffledDistractors.length; i++) {
          if (!correctParts.includes(shuffledDistractors[i])) {
            selectedDistractors.push(shuffledDistractors[i]);
          }
        }

        const allParts = [...correctParts, ...selectedDistractors];
        console.log('All parts:', allParts);
        
        setShuffledParts(shuffleArray(allParts));
        setSelectedParts([]);
        setTypedAnswer('');
        setShowFeedback(false);
        setIsCorrect(false);
        
        console.log('setupQuestion completed');
      };

      const startNewSentenceSet = () => {
        const sentences = selectedPattern.sentences[difficulty];
        const randomSentence = sentences[Math.floor(Math.random() * sentences.length)];
        setCurrentSentenceSet(randomSentence);

        if (selectedPattern.tenseVariations) {
          setCurrentTense('past');
          setTensesCompleted([]);
          setupQuestion(randomSentence, 'past');
        } else {
          setCurrentTense(null);
          setupQuestion(randomSentence, null);
        }
      };

      const handlePartClick = (part, index) => {
        if (showFeedback) return;
        setSelectedParts([...selectedParts, part]);
        setShuffledParts(shuffledParts.filter((_, i) => i !== index));
      };

      const handleRemovePart = (index) => {
        if (showFeedback) return;
        const partToRemove = selectedParts[index];
        setShuffledParts([...shuffledParts, partToRemove]);
        setSelectedParts(selectedParts.filter((_, i) => i !== index));
      };

      const checkAnswer = () => {
        let userAnswer;
        let correctAnswer;

        if (selectedPattern.tenseVariations) {
          const currentSentence = currentSentenceSet[currentTense];
          userAnswer = inputMode === 'tap' ? selectedParts.join(' ') : typedAnswer.trim();
          correctAnswer = currentSentence.parts.join(' ');
        } else {
          userAnswer = inputMode === 'tap' ? selectedParts.join(' ') : typedAnswer.trim();
          correctAnswer = currentSentenceSet.parts.join(' ');
        }

        const correct = userAnswer === correctAnswer;
        setIsCorrect(correct);
        setShowFeedback(true);
        setQuestionsAnswered(questionsAnswered + 1);

        // Update heat map (only for regular practice, not boss battles)
        if (!bossBattleMode) {
          updateHeatMap(selectedPattern.id, difficulty, correct);
        }

        if (correct) {
          setScore(score + 1);
          if (selectedPattern.tenseVariations) {
            setTensesCompleted([...tensesCompleted, currentTense]);
          }
          
          // Boss battle logic
          if (bossBattleMode) {
            bossAttack();
          }
        } else {
          // Boss battle logic for incorrect answers
          if (bossBattleMode) {
            bossDefend();
          }
        }
      };

      const nextQuestion = () => {
        // Check if we're in Random Mode (no specific tier selected)
        if (!selectedTier) {
          // Generate a new random question
          startRandomMode();
          return;
        }
        
        if (selectedPattern.tenseVariations) {
          if (currentTense === 'past') {
            setCurrentTense('present');
            setupQuestion(currentSentenceSet, 'present');
          } else if (currentTense === 'present') {
            setCurrentTense('future');
            setupQuestion(currentSentenceSet, 'future');
          } else {
            startNewSentenceSet();
          }
        } else {
          startNewSentenceSet();
        }
      };

      const resetToStart = () => {
        setScreen('tier-selection');
        setSelectedTier(null);
        setSelectedPattern(null);
        setDifficulty(null);
        setInputMode(null);
        setCurrentSentenceSet(null);
        setChallengeMode(null);
        setTimeLimit(null);
        setScore(0);
        setStreak(0);
        setQuestionsAnswered(0);
      };

      if (!grammarPatterns) {
        console.log('Rendering loading state');
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 flex items-center justify-center">
            <div className="text-2xl text-purple-600">Loading...</div>
          </div>
        );
      }

      if (screen === 'tier-selection') {
        console.log('Rendering tier selection screen');
        
        // Floating Korean characters
        const hangeulChars = ['ㄱ', 'ㄴ', 'ㄷ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅅ', 'ㅇ', 'ㅈ', 'ㅎ', '가', '나', '다', '라', '마'];
        
        console.log('About to render tier selection with hangeul chars:', hangeulChars.length);
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-violet-400 via-fuchsia-300 to-cyan-300 relative overflow-hidden flex items-center justify-center p-4">
            {/* Floating mesh blobs */}
            <div className="absolute inset-0 overflow-hidden">
              <div className="absolute top-20 left-20 w-64 h-64 bg-purple-400 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
              <div className="absolute top-40 right-20 w-64 h-64 bg-yellow-400 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob" style={{animationDelay: '2s'}}></div>
              <div className="absolute -bottom-8 left-1/2 w-64 h-64 bg-pink-400 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob" style={{animationDelay: '4s'}}></div>
            </div>
            
            {/* Floating Korean characters */}
            {hangeulChars.map((char, index) => (
              <div
                key={index}
                className="absolute text-white opacity-10 animate-float pointer-events-none"
                style={{
                  left: `${(index * 7) % 100}%`,
                  top: `${(index * 11) % 100}%`,
                  fontSize: `${40 + (index % 6) * 10}px`,
                  animationDelay: `${index * 1.5}s`,
                  animationDuration: `${15 + (index % 5) * 2}s`
                }}
              >
                {char}
              </div>
            ))}
            
            {/* Main glassmorphism card */}
            <div className="relative bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/30 max-w-2xl w-full p-8 md:p-12">
              {/* Header Section */}
              <div className="text-center mb-12">
                {/* Sparkle Icon with animated dots */}
                <div className="relative flex justify-center mb-6">
                  <div className="relative">
                    <Sparkles className="w-20 h-20 text-purple-600 drop-shadow-lg" />
                    <div className="absolute -top-2 -right-2 w-3 h-3 bg-yellow-400 rounded-full animate-ping"></div>
                    <div className="absolute -bottom-2 -left-2 w-3 h-3 bg-pink-400 rounded-full animate-bounce"></div>
                  </div>
                </div>
                
                {/* Main Title with animated gradient */}
                <div className="relative mb-6">
                  <h1 className="text-6xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-[length:200%_auto] animate-gradient-text">
                    한국어 문법
                  </h1>
                  {/* Pulsing glow effect */}
                  <div className="absolute inset-0 text-6xl md:text-7xl font-black text-purple-600/20 blur-sm animate-pulse">
                    한국어 문법
                  </div>
                </div>
                
                {/* Korean Subtitle Badge */}
                <div className="inline-block mb-6">
                  <div className="bg-gradient-to-r from-purple-100 to-pink-100 border-2 border-purple-200 rounded-full px-6 py-3">
                    <p className="text-purple-900 font-bold text-lg">문법 패턴을 마스터하세요 ✨</p>
                  </div>
                </div>
                
                {/* Call to Action */}
                <p className="text-gray-700 font-medium animate-bounce-subtle">
                  👇 티어를 선택하여 시작하세요 👇
                </p>
              </div>

              {/* Button Grid */}
              <div className="space-y-4">
                <button onClick={() => { setSelectedTier('beginner'); setScreen('pattern-selection'); }} className="group w-full bg-gradient-to-r from-emerald-400 to-emerald-600 hover:from-emerald-500 hover:to-emerald-700 text-white font-bold py-6 px-6 rounded-xl transition-all duration-300 hover:scale-[1.02] hover:-translate-y-1 hover:shadow-2xl relative overflow-hidden">
                  {/* Shine effect */}
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                  
                  <div className="relative flex items-center justify-center mb-2">
                    <Star className="w-8 h-8 mr-3 drop-shadow-lg animate-twinkle" style={{animationDelay: '0s'}} />
                    <span className="text-3xl font-black drop-shadow-lg group-hover:scale-110 transition-transform duration-300">초급</span>
                  </div>
                  <div className="relative">
                    <div className="text-xs font-semibold uppercase tracking-wider opacity-90 mb-1">Beginner</div>
                    <div className="bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full border border-white/30 inline-block">
                      <span className="font-bold drop-shadow">8개 패턴</span>
                    </div>
                  </div>
                </button>

                <button onClick={() => { setSelectedTier('intermediate'); setScreen('pattern-selection'); }} className="group w-full bg-gradient-to-r from-amber-400 to-amber-600 hover:from-amber-500 hover:to-amber-700 text-white font-bold py-6 px-6 rounded-xl transition-all duration-300 hover:scale-[1.02] hover:-translate-y-1 hover:shadow-2xl relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                  
                  <div className="relative flex items-center justify-center mb-2">
                    <Star className="w-8 h-8 mr-3 drop-shadow-lg animate-twinkle" style={{animationDelay: '0.3s'}} />
                    <span className="text-3xl font-black drop-shadow-lg group-hover:scale-110 transition-transform duration-300">중급</span>
                  </div>
                  <div className="relative">
                    <div className="text-xs font-semibold uppercase tracking-wider opacity-90 mb-1">Intermediate</div>
                    <div className="bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full border border-white/30 inline-block">
                      <span className="font-bold drop-shadow">10개 패턴</span>
                    </div>
                  </div>
                </button>

                <button onClick={() => { setSelectedTier('advanced'); setScreen('pattern-selection'); }} className="group w-full bg-gradient-to-r from-rose-400 to-rose-600 hover:from-rose-500 hover:to-rose-700 text-white font-bold py-6 px-6 rounded-xl transition-all duration-300 hover:scale-[1.02] hover:-translate-y-1 hover:shadow-2xl relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                  
                  <div className="relative flex items-center justify-center mb-2">
                    <Star className="w-8 h-8 mr-3 drop-shadow-lg animate-twinkle" style={{animationDelay: '0.6s'}} />
                    <span className="text-3xl font-black drop-shadow-lg group-hover:scale-110 transition-transform duration-300">고급</span>
                  </div>
                  <div className="relative">
                    <div className="text-xs font-semibold uppercase tracking-wider opacity-90 mb-1">Advanced</div>
                    <div className="bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full border border-white/30 inline-block">
                      <span className="font-bold drop-shadow">10개 패턴</span>
                    </div>
                  </div>
                </button>

                <button onClick={() => { setSelectedTier('combo'); setScreen('pattern-selection'); }} className="group w-full bg-gradient-to-r from-purple-500 to-purple-700 hover:from-purple-600 hover:to-purple-800 text-white font-bold py-6 px-6 rounded-xl transition-all duration-300 hover:scale-[1.02] hover:-translate-y-1 hover:shadow-2xl relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                  
                  <div className="relative flex items-center justify-center mb-2">
                    <Star className="w-8 h-8 mr-3 drop-shadow-lg animate-twinkle" style={{animationDelay: '0.9s'}} />
                    <span className="text-3xl font-black drop-shadow-lg group-hover:scale-110 transition-transform duration-300">콤보 티어</span>
                  </div>
                  <div className="relative">
                    <div className="text-xs font-semibold uppercase tracking-wider opacity-90 mb-1">Combo Tier</div>
                    <div className="bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full border border-white/30 inline-block">
                      <span className="font-bold drop-shadow">5개 결합 패턴</span>
                    </div>
                  </div>
                </button>

                <button onClick={() => startRandomMode()} className="group w-full bg-gradient-to-r from-indigo-500 to-blue-600 hover:from-indigo-600 hover:to-blue-700 text-white font-bold py-6 px-6 rounded-xl transition-all duration-300 hover:scale-[1.02] hover:-translate-y-1 hover:shadow-2xl relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                  
                  <div className="relative flex items-center justify-center mb-2">
                    <Zap className="w-8 h-8 mr-3 drop-shadow-lg animate-twinkle" style={{animationDelay: '1.2s'}} />
                    <span className="text-3xl font-black drop-shadow-lg group-hover:scale-110 transition-transform duration-300">랜덤 모드</span>
                  </div>
                  <div className="relative">
                    <div className="text-xs font-semibold uppercase tracking-wider opacity-90 mb-1">Random Mode</div>
                    <div className="bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full border border-white/30 inline-block">
                      <span className="font-bold drop-shadow">모든 패턴, 모든 문장!</span>
                    </div>
                  </div>
                </button>

                <button onClick={startBossBattle} className="group w-full bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold py-6 px-6 rounded-xl transition-all duration-300 hover:scale-[1.02] hover:-translate-y-1 hover:shadow-2xl relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                  
                  <div className="relative flex items-center justify-center mb-2">
                    <Brain className="w-8 h-8 mr-3 drop-shadow-lg animate-twinkle" style={{animationDelay: '1.5s'}} />
                    <span className="text-3xl font-black drop-shadow-lg group-hover:scale-110 transition-transform duration-300">보스 배틀</span>
                  </div>
                  <div className="relative">
                    <div className="text-xs font-semibold uppercase tracking-wider opacity-90 mb-1">Boss Battle</div>
                    <div className="bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full border border-white/30 inline-block">
                      <span className="font-bold drop-shadow">콤보 패턴과 싸우세요!</span>
                    </div>
                  </div>
                </button>

                <button onClick={() => setScreen('heat-map')} className="group w-full bg-gradient-to-r from-blue-500 to-cyan-600 hover:from-blue-600 hover:to-cyan-700 text-white font-bold py-6 px-6 rounded-xl transition-all duration-300 hover:scale-[1.02] hover:-translate-y-1 hover:shadow-2xl relative overflow-hidden">
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 transform -translate-x-full group-hover:translate-x-full transition-transform duration-700"></div>
                  
                  <div className="relative flex items-center justify-center mb-2">
                    <Star className="w-8 h-8 mr-3 drop-shadow-lg animate-twinkle" style={{animationDelay: '1.8s'}} />
                    <span className="text-3xl font-black drop-shadow-lg group-hover:scale-110 transition-transform duration-300">히트 맵</span>
                  </div>
                  <div className="relative">
                    <div className="text-xs font-semibold uppercase tracking-wider opacity-90 mb-1">Heat Map</div>
                    <div className="bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full border border-white/30 inline-block">
                      <span className="font-bold drop-shadow">진행 상황을 추적하세요</span>
                    </div>
                  </div>
                </button>
              </div>

              {/* Footer */}
              <div className="mt-12 text-center">
                <p className="text-gray-600 font-medium">연습이 완벽을 만든다 · Practice makes perfect</p>
                <div className="flex justify-center mt-3">
                  <Shuffle className="w-6 h-6 text-gray-500" />
                </div>
              </div>
            </div>
          </div>
        );
      }


      if (screen === 'heat-map') {
        const stats = getHeatMapStats();
        const hasData = Object.keys(stats).length > 0;
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <button onClick={() => setScreen('tier-selection')} className="flex items-center text-gray-600 hover:text-gray-800 mb-4 transition-colors">
                <ArrowLeft /><span className="ml-2">Back</span>
              </button>
              <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Learning Heat Map</h2>
              
              {!hasData ? (
                <div className="text-center py-8">
                  <div className="text-6xl mb-4">📊</div>
                  <p className="text-gray-600 mb-4">No practice data yet!</p>
                  <p className="text-sm text-gray-500">Start practicing grammar patterns to see your progress here.</p>
                </div>
              ) : (
                <>
                  <div className="mb-6 flex justify-between items-center">
                    <p className="text-gray-600">Your practice statistics:</p>
                    <button onClick={resetHeatMap} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                      Reset Data
                    </button>
                  </div>
                  
                  <div className="space-y-4">
                    {Object.entries(stats).map(([key, data]) => {
                      const [tier, patternId] = key.split('-');
                      const pattern = grammarPatterns?.[tier]?.find(p => p.id === patternId);
                      const patternName = pattern ? pattern.name : `${tier}-${patternId}`;
                      
                      return (
                        <div key={key} className={`p-4 rounded-xl border-2 ${data.needsWork ? 'border-red-200 bg-red-50' : data.accuracy >= 80 ? 'border-green-200 bg-green-50' : 'border-yellow-200 bg-yellow-50'}`}>
                          <div className="flex justify-between items-start mb-2">
                            <div>
                              <h3 className="font-bold text-lg">{patternName}</h3>
                              <p className="text-sm text-gray-600 capitalize">{tier} level</p>
                            </div>
                            <div className="text-right">
                              <div className={`text-2xl font-bold ${data.needsWork ? 'text-red-600' : data.accuracy >= 80 ? 'text-green-600' : 'text-yellow-600'}`}>
                                {data.accuracy}%
                              </div>
                              <p className="text-xs text-gray-500">{data.practiced} attempts</p>
                            </div>
                          </div>
                          
                          <div className="w-full bg-gray-200 rounded-full h-2 mb-2">
                            <div 
                              className={`h-2 rounded-full ${data.needsWork ? 'bg-red-500' : data.accuracy >= 80 ? 'bg-green-500' : 'bg-yellow-500'}`}
                              style={{ width: `${data.accuracy}%` }}
                            ></div>
                          </div>
                          
                          <div className="flex justify-between text-xs text-gray-600">
                            <span>{data.needsWork ? '⚠️ Needs more practice' : data.accuracy >= 80 ? '🎉 Excellent!' : '📈 Keep practicing!'}</span>
                            <span>{data.correct}/{data.practiced} correct</span>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  <div className="mt-6 p-4 bg-blue-50 rounded-xl">
                    <h3 className="font-bold text-blue-800 mb-2">Legend:</h3>
                    <div className="grid grid-cols-3 gap-2 text-sm">
                      <div className="flex items-center">
                        <div className="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span className="text-green-700">80%+ accuracy</span>
                      </div>
                      <div className="flex items-center">
                        <div className="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                        <span className="text-yellow-700">50-79% accuracy</span>
                      </div>
                      <div className="flex items-center">
                        <div className="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                        <span className="text-red-700">Below 50% accuracy</span>
                      </div>
                    </div>
                  </div>
                </>
              )}
            </div>
          </div>
        );
      }

      if (screen === 'boss-battle') {
        if (!currentBoss || !currentSentenceSet) {
          return (
            <div className="min-h-screen bg-gradient-to-br from-red-50 to-orange-100 flex items-center justify-center p-4">
              <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                <div className="text-6xl mb-4">🔥</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Boss Battle Loading...</h2>
                <button onClick={() => setScreen('tier-selection')} className="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                  Back to Menu
                </button>
              </div>
            </div>
          );
        }

        const currentSentence = currentSentenceSet;

        return (
          <div className="min-h-screen bg-gradient-to-br from-red-50 to-orange-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-6 max-w-2xl w-full">
              {/* Boss Battle Header */}
              <div className="bg-red-100 rounded-xl p-4 mb-6 border-2 border-red-300">
                <div className="flex justify-between items-center mb-3">
                  <div>
                    <h2 className="text-xl font-bold text-red-800">🔥 BOSS BATTLE</h2>
                    <p className="text-sm text-red-600">{currentBoss.name}</p>
                    <p className="text-xs text-red-500">{currentBoss.specialAbility}</p>
                  </div>
                  <div className="text-right">
                    <div className="text-lg font-bold text-red-800">Attacks Remaining: {currentBoss.attacksRemaining}</div>
                    <div className="text-sm text-red-600">Score: {score}</div>
                  </div>
                </div>
                
                <div className="w-full bg-red-200 rounded-full h-3">
                  <div 
                    className="bg-red-600 h-3 rounded-full transition-all duration-500" 
                    style={{ width: `${(currentBoss.attacksRemaining / 5) * 100}%` }}
                  ></div>
                </div>
                <p className="text-xs text-red-700 mt-1">Boss Health: {currentBoss.attacksRemaining}/5</p>
              </div>

              {/* Current Sentence */}
              <div className="mb-6 p-4 bg-gray-50 rounded-xl">
                <h3 className="font-bold text-gray-800 mb-2">Defeat the boss by completing this combo sentence:</h3>
                <p className="text-sm text-gray-600 mb-3">{currentBoss.description}</p>
                
                {/* Show meaning only for typing mode */}
                <div className="mb-4 p-3 bg-blue-50 border-2 border-blue-200 rounded-lg">
                  <p className="text-sm font-bold text-blue-800 mb-1">Translate this meaning to Korean:</p>
                  <p className="text-lg font-semibold text-blue-900">{currentSentence.meaning}</p>
                </div>
                
                {inputMode === 'tap' ? (
                  <div className="mb-4">
                    <div className="flex flex-wrap gap-2 mb-4">
                      {selectedParts.map((part, index) => (
                        <button
                          key={index}
                          onClick={() => removePart(index)}
                          className="bg-blue-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-blue-600 transition-colors"
                        >
                          {part}
                        </button>
                      ))}
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {shuffledParts.map((part, index) => (
                        <button
                          key={index}
                          onClick={() => addPart(part, index)}
                          className="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-2 rounded-lg font-semibold transition-colors"
                        >
                          {part}
                        </button>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div className="mb-4">
                    <input
                      type="text"
                      value={typedAnswer}
                      onChange={(e) => setTypedAnswer(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && checkAnswer()}
                      placeholder="Type your answer here..."
                      className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none text-lg"
                    />
                  </div>
                )}

                <button
                  onClick={checkAnswer}
                  disabled={showFeedback}
                  className="w-full bg-red-500 hover:bg-red-600 disabled:bg-gray-400 text-white font-bold py-3 px-6 rounded-xl transition-colors"
                >
                  {showFeedback ? (isCorrect ? '✅ Correct!' : '❌ Try Again') : 'Attack Boss!'}
                </button>

                {showFeedback && (
                  <div className={`mt-4 p-4 rounded-xl ${isCorrect ? 'bg-green-100 border-2 border-green-300' : 'bg-red-100 border-2 border-red-300'}`}>
                    <p className={`font-bold ${isCorrect ? 'text-green-800' : 'text-red-800'}`}>
                      {isCorrect ? '🎉 Great attack! Boss takes damage!' : '💥 Boss deflects your attack! Try again!'}
                    </p>
                    {!isCorrect && (
                      <div className="mt-3">
                        <p className="text-sm text-gray-700">
                          <strong>Your answer:</strong> {inputMode === 'tap' ? selectedParts.join(' ') : typedAnswer}
                        </p>
                        <p className="text-sm text-gray-700 mt-1">
                          <strong>Correct answer:</strong> {currentSentence.parts.join(' ')}
                        </p>
                        <p className="text-sm text-gray-600 mt-1">
                          <strong>Meaning:</strong> {currentSentence.meaning}
                        </p>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Battle Instructions */}
              <div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4">
                <h4 className="font-bold text-yellow-800 mb-2">⚔️ Battle Rules:</h4>
                <ul className="text-sm text-yellow-700 space-y-1">
                  <li>• Type the Korean translation of the English meaning above</li>
                  <li>• These are complex sentences combining 2-4 grammar patterns</li>
                  <li>• Correct answers deal damage to the boss</li>
                  <li>• Wrong answers make the boss stronger</li>
                  <li>• You need 5 successful attacks to win</li>
                  <li>• Each wrong answer adds +1 to boss health</li>
                </ul>
              </div>

              <div className="mt-4 text-center">
                <button onClick={() => { setBossBattleMode(false); setScreen('tier-selection'); setCurrentBoss(null); }} className="text-gray-600 hover:text-gray-800 font-semibold transition-colors">
                  Flee Battle
                </button>
              </div>
            </div>
          </div>
        );
      }

      if (screen === 'pattern-selection') {
        const patterns = grammarPatterns[selectedTier];
        const backScreen = challengeMode ? 'challenge-selection' : 'tier-selection';
        
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
              <button onClick={() => setScreen(backScreen)} className="flex items-center text-gray-600 hover:text-gray-800 mb-4 transition-colors">
                <ArrowLeft /><span className="ml-2">Back</span>
              </button>
              <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">
                {selectedTier === 'combo' ? 'Combo Patterns' : 'Select Pattern'}
              </h2>
              {challengeMode && (
                <div className="mb-4 p-3 bg-blue-100 rounded-lg">
                  <div className="text-blue-800 font-semibold">
                    {challengeMode === 'speed' && '⚡ Speed Round Active'}
                    {challengeMode === 'memory' && '🧠 Memory Challenge Active'}
                    {challengeMode === 'combo-challenge' && '✨ Combo Challenge Active'}
                  </div>
                </div>
              )}
              <div className="space-y-3">
                {patterns.map((pattern) => (
                  <button key={pattern.id} onClick={() => { setSelectedPattern(pattern); setScreen('difficulty-selection'); }} className="w-full bg-purple-100 hover:bg-purple-200 text-left p-4 rounded-xl transition-colors">
                    <div className="font-bold text-purple-900 text-lg">{pattern.name}</div>
                    <div className="text-purple-700 text-sm">{pattern.description}</div>
                    {selectedTier === 'combo' && (
                      <div className="text-xs text-purple-600 mt-1">🌟 Multiple patterns combined</div>
                    )}
                  </button>
                ))}
              </div>
            </div>
          </div>
        );
      }

      if (screen === 'difficulty-selection') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
              <button onClick={() => setScreen('pattern-selection')} className="flex items-center text-gray-600 hover:text-gray-800 mb-4 transition-colors">
                <ArrowLeft /><span className="ml-2">Back</span>
              </button>
              <div className="bg-purple-50 rounded-xl p-4 mb-6">
                <div className="font-bold text-purple-900 text-xl">{selectedPattern.name}</div>
                <div className="text-purple-700 text-sm">{selectedPattern.explanation}</div>
              </div>
              <h2 className="text-xl font-bold text-gray-800 mb-6 text-center">Sentence length:</h2>
              <div className="space-y-3">
                <button onClick={() => { setDifficulty('beginner'); setScreen('input-mode-selection'); }} className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl transition-colors">Short</button>
                <button onClick={() => { setDifficulty('intermediate'); setScreen('input-mode-selection'); }} className="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-xl transition-colors">Medium</button>
                <button onClick={() => { setDifficulty('advanced'); setScreen('input-mode-selection'); }} className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl transition-colors">Long</button>
              </div>
            </div>
          </div>
        );
      }

      if (screen === 'input-mode-selection') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
              <button onClick={() => setScreen('difficulty-selection')} className="flex items-center text-gray-600 hover:text-gray-800 mb-4 transition-colors">
                <ArrowLeft /><span className="ml-2">Back</span>
              </button>
              <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Input mode:</h2>
              <div className="space-y-3">
                <button onClick={() => { setInputMode('tap'); setScreen('practice'); startNewSentenceSet(); }} className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-xl transition-colors">Tap Words</button>
                <button onClick={() => { setInputMode('type'); setScreen('practice'); startNewSentenceSet(); }} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition-colors">Type Answer</button>
              </div>
            </div>
          </div>
        );
      }

      if (screen === 'practice' && currentSentenceSet) {
        const currentSentence = selectedPattern.tenseVariations ? currentSentenceSet[currentTense] : currentSentenceSet;

        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-3xl shadow-2xl p-6 max-w-2xl w-full">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <span className="text-sm font-bold text-gray-500">Score: {score}/{questionsAnswered}</span>
                  <div className="text-xs font-semibold text-purple-600 mt-1">
                    {selectedTier ? selectedPattern.name : `🎲 Random Mode - ${selectedPattern.name} (${selectedPattern.tier})`}
                  </div>
                </div>
                <button onClick={resetToStart} className="text-purple-600 hover:text-purple-800 font-semibold text-sm transition-colors">Exit</button>
              </div>

              {selectedPattern.tenseVariations && (
                <div className="flex gap-2 mb-6 justify-center">
                  <div className={`px-4 py-2 rounded-lg font-semibold text-sm ${currentTense === 'past' ? 'bg-blue-500 text-white' : tensesCompleted.includes('past') ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
                    Past {tensesCompleted.includes('past') && '✓'}
                  </div>
                  <div className={`px-4 py-2 rounded-lg font-semibold text-sm ${currentTense === 'present' ? 'bg-purple-500 text-white' : tensesCompleted.includes('present') ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
                    Present {tensesCompleted.includes('present') && '✓'}
                  </div>
                  <div className={`px-4 py-2 rounded-lg font-semibold text-sm ${currentTense === 'future' ? 'bg-orange-500 text-white' : tensesCompleted.includes('future') ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
                    Future {tensesCompleted.includes('future') && '✓'}
                  </div>
                </div>
              )}

              <div className="mb-8">
                <div className="bg-purple-50 rounded-xl p-4 mb-6 text-center">
                  <p className="text-sm text-purple-700 mb-1">Build this sentence:</p>
                  <p className="text-xl font-bold text-purple-900">{currentSentence.meaning}</p>
                </div>

                {inputMode === 'tap' ? (
                  <>
                    <div className="bg-gray-50 rounded-xl p-6 mb-6 min-h-32 border-2 border-dashed border-gray-300">
                      <p className="text-xs text-gray-500 mb-3 text-center">Your sentence:</p>
                      {selectedParts.length === 0 ? (
                        <p className="text-center text-gray-400 text-sm">Tap words below</p>
                      ) : (
                        <div className="flex flex-wrap gap-2 justify-center">
                          {selectedParts.map((part, index) => (
                            <button key={index} onClick={() => handleRemovePart(index)} className="bg-purple-600 text-white px-4 py-3 rounded-lg font-bold text-lg hover:bg-purple-700 transition-colors">{part}</button>
                          ))}
                        </div>
                      )}
                    </div>
                    <div className="mb-6">
                      <p className="text-xs text-gray-500 mb-3 text-center">Available words:</p>
                      <div className="flex flex-wrap gap-2 justify-center">
                        {shuffledParts.map((part, index) => (
                          <button key={index} onClick={() => handlePartClick(part, index)} className="bg-white border-2 border-purple-300 text-purple-700 px-4 py-3 rounded-lg font-bold text-lg hover:bg-purple-50 transition-colors">{part}</button>
                        ))}
                      </div>
                    </div>
                  </>
                ) : (
                  <div className="mb-6">
                    <input type="text" value={typedAnswer} onChange={(e) => setTypedAnswer(e.target.value)} onKeyPress={(e) => { if (e.key === 'Enter' && !showFeedback && typedAnswer.trim()) checkAnswer(); }} placeholder="Type your answer..." disabled={showFeedback} className="w-full px-4 py-4 text-lg border-2 border-purple-300 rounded-xl focus:outline-none focus:border-purple-500 transition-colors" autoFocus />
                  </div>
                )}

                {showFeedback && (
                  <div className={`rounded-xl p-4 mb-6 ${isCorrect ? 'bg-green-50' : 'bg-red-50'}`}>
                    <div className="flex items-center justify-center mb-2">
                      {isCorrect ? (
                        <><div className="text-green-600 mr-2"><CheckCircle /></div><span className="text-green-800 font-bold">Perfect!</span></>
                      ) : (
                        <><div className="text-red-600 mr-2"><XCircle /></div><span className="text-red-800 font-bold">Not quite</span></>
                      )}
                    </div>
                    {!isCorrect && (
                      <div className="text-center">
                        <p className="text-red-700 text-sm">Correct:</p>
                        <p className="text-red-900 font-bold text-xl">{currentSentence.parts.join(' ')}</p>
                      </div>
                    )}
                  </div>
                )}

                <div className="flex flex-col gap-3">
                  {!showFeedback ? (
                    <>
                      <button onClick={checkAnswer} disabled={inputMode === 'tap' ? selectedParts.length !== currentSentence.parts.length : !typedAnswer.trim()} className={`w-full font-bold py-4 rounded-xl text-lg transition-colors ${(inputMode === 'tap' ? selectedParts.length === currentSentence.parts.length : typedAnswer.trim()) ? 'bg-purple-600 text-white hover:bg-purple-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>Check</button>
                      <button onClick={() => { setIsCorrect(false); setShowFeedback(true); setQuestionsAnswered(questionsAnswered + 1); }} className="w-full bg-orange-500 text-white font-bold py-3 rounded-xl hover:bg-orange-600 transition-colors">Show Answer</button>
                    </>
                  ) : (
                    <button onClick={nextQuestion} className="w-full bg-purple-600 text-white font-bold py-4 rounded-xl flex items-center justify-center hover:bg-purple-700 transition-colors">
                      <span>{selectedPattern.tenseVariations && currentTense !== 'future' ? 'Next Tense' : 'New Sentence'}</span>
                      <div className="ml-2"><ArrowRight /></div>
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      console.log('Reached return null - this should not happen!');
      console.log('Current state:', { grammarPatterns: !!grammarPatterns, screen });
      return null;
    };

    console.log('About to render KoreanGrammarApp...');
    console.log('React version:', React.version);
    console.log('ReactDOM version:', ReactDOM.version);
    console.log('Root element:', document.getElementById('root'));
    
    try {
      ReactDOM.render(<KoreanGrammarApp />, document.getElementById('root'));
      console.log('KoreanGrammarApp rendered successfully!');
    } catch (error) {
      console.error('Error rendering KoreanGrammarApp:', error);
    }
  </script>
</body>
</html>